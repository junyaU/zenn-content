---
title: "自作OSにネットワーク機能を実装してpingに応答させる"
emoji: "🏓"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---

## はじめに
自作しているOSにネットワーク機能とpingコマンドの実装を行いました。

自作OSにネットワーク機能を追加し、最終的に **ping が通るところまで**を実装しました。
しかし、ARP・IP・ICMP といった基礎プロトコルの処理まで含めると記事が長くなるため、全体を三回の連載として分割して解説します。
本記事ではその第1回として、ホスト（WSL2）から自作 OS に送られる ARP Request と ICMP Echo Request（ping）に応答するまでの処理に焦点を当てます。
扱う範囲はOSI参照モデルの1〜3層に相当します。

## 前提知識
本記事では以下の前提知識を持っていることを想定しています。
- OSI参照モデルの1〜3層の基礎知識
- IPアドレスとMACアドレスの違いと役割
- pingコマンドの基本的な理解
## やったことの全体像
今回は、自作 OS にネットワーク機能を追加し、最終的にホスト環境（WSL2）からの ping に応答できるところまでを実装しました。
- ARP リクエストへの応答（MAC アドレス解決）
- ICMP Echo Request（ping）への応答

実際に自作 OS 上で行っている処理の全体像は次のとおりです。
```
┌───────────┐
│   virtio-net  │  ← QEMUの仮想 NIC
└───────┬─────┘
        │ パケット受信
        ▼
┌───────────┐
│   OSカーネル   │
│  ・virtqueue からパケット受け取り
│  ・ネットワークプロセスへ転送
└───────┬─────┘
        │
        ▼
┌───────────┐
│ network プロセス │
└───────┬─────┘
        │
        ├── ARP パケット？
        │        └→ ARP Reply を生成して送信
        │
        └── IP パケット？
                └── ICMP Echo Request？
                        └→ ICMP Echo Reply を生成して送信
```
virtio-net という 最下層の仮想 NIC からパケットを受信し、OS 内でヘッダを順に解析しながら、プロトコルごとに応答を返す最小限のネットワークスタックを実装しています。
本記事では、
- virtio-net からパケットを受け取る仕組み
- ARP / ICMP 各ヘッダの解析方法
- 応答パケット（ARP Reply / ICMP Echo Reply）の組み立て手順

といった **ping に応答するまでに必要な最低限のネットワーク処理の流れ**を順を追って解説します。

## virtio-netからパケット受信
### virtio-netとは
virtio-netは、Virtioという準仮想化フレームワーク上で提供される仮想NICです。
Virtioそのものの仕組みについては、以前公開した以下の記事で詳しく解説しています
https://zenn.dev/junjunjunjun/articles/27ede76931cc85
本記事では、**OS にネットワークパケットを届けてくれる仮想NIC」**として理解しておけば問題ありません。
### 設定
virtio-net を利用するために、ホスト側で TAPデバイスを作成し、IPアドレスを割り当てます。
```bash
# TAPデバイスの作成
ip tuntap add dev tap0 mode tap

# IPアドレス設定
ip addr add 192.168.100.1/24 dev tap0

# デバイス有効化
ip link set tap0 up

# パケット転送を有効化
sysctl -w net.ipv4.ip_forward=1
```
この設定により、`tap0` という名前のTAPデバイスに、`192.168.100.1/24` のプライベートIPアドレスを割り当てた状態になります。
QEMU の virtio-net デバイスをこの tap0 に接続することで、自作 OS がホストと同一ネットワーク上に存在するように振る舞うことができます。

QEMU の起動オプションは以下のようになります。
```bash
qemu-system-x86_64 \
    -netdev tap,id=net0,ifname=tap0,script=no \
    -device virtio-net-pci,netdev=net0,mac=52:54:00:12:34:56 \
```
MAC アドレスは任意ですが、ローカルネットワーク内で衝突しない値を指定する必要があります。

### パケットを取り出してnetworkプロセスに送信
virtio-net デバイスは、受信パケットをカーネルが用意したバッファ（virtqueue）に直接書き込みます。
カーネル側では以下を行っています。

1. 受信キュー（receive queue）に登録したバッファへ、virtio-net がパケットを書き込む
2. デバイスからの通知（※今回はポーリング）で、パケットが到着したことを検出
3. virtqueue からパケットを回収
4. パケット内容を network プロセスへ転送

この段階ではまだ ARP や ICMP の解析は行わず、
**受信したパケットをnetworkプロセスに届ける**という最小限の役割だけを担っています。


<!-- ホストからpingを送信し、自作OS側でパケットを受け取れている様子の動画をここに貼る -->
ホスト側から以下のコマンドを実行すると、自作OSがパケットを受信している様子を確認できます。
```bash
ping 192.168.100.1
```
ただし現時点では、ARP 応答や ICMP Echo Reply を実装していないため、
ホストからは 送信はできても応答が返ってこずタイムアウトする 状態です。

<!-- wiresharkのキャプチャ -->

## ARPリクエストパケットに応答
ここからは`network`プロセス内の処理について解説します。
### ARPとは
ARP（Address Resolution Protocol）は、IPアドレスから対応するMACアドレスを取得するためのプロトコルです。

### 構造解析
### レスポンスの構築
## ICMPリクエストパケットに応答
### ICMPとは
### エコーリクエストの解析
### エコーリプライの構築
### pingの疎通確認
## ハマったポイント
## おわりに
## 参考資料