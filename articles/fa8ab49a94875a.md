---
title: "自作OSにネットワーク機能を実装してpingに応答させる"
emoji: "🏓"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---

## はじめに
自作しているOSにネットワーク機能とpingコマンドの実装を行いました。
全ての内容を一つの記事にまとめると非常に長くなってしまうため、三回の連載に分けて解説していきます。
今回はローカルネットワーク内のデバイスからのpingに応答する部分に絞って解説します。

## 前提知識
本記事では以下の前提知識を持っていることを想定しています。
- OSI参照モデルの1〜3層の基礎知識
- IPアドレスとMACアドレスの違いと役割
## やったことの全体像
今回は、自作OSにネットワーク機能を追加し、最終的にローカルネットワークからの ping に応答できるところまでを実装します。
その中で本記事では、以下の 2 つの処理に焦点を当てます。
- ARP リクエストへの応答（MAC アドレス解決）
- ICMP Echo Request（ping）への応答

実際に自作 OS 上で行っている処理の全体像は次のとおりです。
```
┌───────────┐
│   virtio-net  │  ← QEMUの仮想 NIC
└───────┬─────┘
        │ パケット受信
        ▼
┌───────────┐
│   OSカーネル   │
│  ・virtqueue からパケットを取り出す
│  ・ネットワークプロセスへ転送
└───────┬─────┘
        │
        ▼
┌───────────┐
│ network プロセス │
└───────┬─────┘
        │
        ├── ARP パケット？
        │        └→ ARP Reply を生成して送信
        │
        └── IP パケット？
                └── ICMP Echo Request？
                        └→ ICMP Echo Reply を生成して送信
```
ネットワークスタックの最下層である virtio-net からパケットを受け取り、それを自作 OS 内で逐次解析し、プロトコルごとに適切な応答を返す仕組みを実装しました。
本記事では、
- virtio-net からパケットを受け取るまでの仕組み
- ARP や ICMP のヘッダをどのように解析したか
- どのようにレスポンスパケットを組み立てるか

といった 「ping 応答に最低限必要なネットワーク処理」 を順を追って解説していきます。

## virtio-netからパケット受信
### virtio-netの概要
### QEMUでの設定
### パケットを取り出してnetworkプロセスに送信
## ARPリクエストパケットに応答
### ARPとは
### 構造解析
### レスポンスの構築
## ICMPリクエストパケットに応答
### ICMPとは
### エコーリクエストの解析
### エコーリプライの構築
### pingの疎通確認
## ハマったポイント
## おわりに
## 参考資料